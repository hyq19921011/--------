<<<<<<< HEAD
C51 COMPILER V9.00   MAIN                                                                  06/23/2015 07:53:34 PAGE 1   
=======
C51 COMPILER V9.00   MAIN                                                                  06/16/2015 21:32:12 PAGE 1   
>>>>>>> parent of 838f16f... ËØ¥ÊòéÔºö‰øÆÊîπËá≥ÊúÄÊñ∞ÔºåÊåâÈîÆÊúâÂ§ßÁöÑÊîπÂä®ÔºåÂ¢ûÂä†‰ø°Âè∑Ê£ÄÊµãÁ´ØÂè£„ÄÇ


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE source\main.c RTX51 OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Lis
                    -tings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          
   2          /***************
   3          œÓƒø√˚≥∆£∫µÁ∂Ø≥µ≥‰µÁ∆˜øÿ÷∆∆˜
   4          π¶ƒ‹£∫    ∏˘æ›µÁ≥ÿµÁ¡øµƒ≤ªÕ¨∫œ¿Ìøÿ÷∆≥‰µÁµÁ¡˜£¨±£ª§µÁ≥ÿ Ÿ√¸°£
   5          ◊˜’ﬂ£∫    ∫”ƒœø∆ºº¥Û—ß----ª∆”¿»´
   6          »’∆⁄£∫    2015/06/04
   7          **************/
   8          /**************Õ∑Œƒº˛**************/
   9          #include <STC15F2K60S2.H>
  10          #include "main.h"
  11          #include "stdio.h"
  12          #include "adc.h"
  13          #include "led.h"
  14          #include "key.h"
  15          #include "pwm_dac.h"
  16          #include "time.h"
  17          #include "delay.h"
  18          #include "usart.h"
  19          #include "eeprom.h"
  20          
  21          /***********œµÕ≥±‰¡ø∂®“Â**********/
  22          WORD Time_Base = 0;//œµÕ≥ ±ª˘
  23          SYSTime SYS_Time;  //œµÕ≥ ±÷”
  24          BYTE SYS_STEP = 1; //œµÕ≥÷¥––µƒ≤Ω÷Ë
  25          u16 AD_Time = 0;
  26          u16 AD = 1023;    //≤…ºØªÿ¿¥µƒAD÷µ
<<<<<<< HEAD
  27          u16 AD0 = 1023;   //“Ï≥£«Èøˆ≤…ºØ
  28          BYTE DA = 10;      
  29          //BYTE CurrentBase[6] = {0x00,0x80,0x67,0x33,0x19,0};//0\2.5\2.0\1.0\0.5 µÁ¡˜ª˘◊º
  30          //BYTE VoltageBase[6] = {0x00,0x9a,0xce,0xce,0xb4,0};//0\3\4\4\3.5       µÁ—πª˘◊º
  31          //WORD CurrentInput[6] = {0x00,0x019f,0x00d1,0x006a,0,0};//0\2\1\0.5\      µÁ¡˜ ‰»Î–≈∫≈
  32          BYTE CurrentBase[6] = {0x00,0x9a,0x80,0x4d,0x19,0};//0\3\2.5\1.5\1 µÁ¡˜ª˘◊º
  33          BYTE VoltageBase[6] = {0x00,0xb8,0xce,0xce,0xb8,0};//0\3.6\4\4\3.6       µÁ—πª˘◊º
  34          WORD CurrentInput[6] = {0x00,0x0200,0x010a,0x00d1,0,0};//0\2.5\1.3\1.0\   µÁ¡˜ ‰»Î–≈∫≈
  35          BYTE Current_Base = 0;
  36          BYTE Voltage_Base = 0;
  37          BYTE Change_Num = 0; //—°‘Ò≤Œ ˝œÓ
  38          BYTE Wait_Flag = 0;
  39          BYTE Save_Flag = 0;//¥Ê¥¢ ˝æ›µƒ±Í÷æ
  40          BYTE Warrning_Flag = 0;//¥Ê¥¢ ˝æ›µƒ±Í÷æ
  41          u16 time_wait =0;
  42          u8  Current_Time = 0;
  43          
  44          void user_app()//”√ªß≥Ã–Ú
  45          {
  46   1          u8 key_stateValue;  
  47   1          u8* pKeyValue;  
  48   1          *pKeyValue=0;  
  49   1          key_stateValue=read_key(pKeyValue); 
  50   1      //      if(Key_Lock==1)//À¯∂®º¸£¨Œ™1Ω‚≥˝À¯∂®£¨Œ™0À¯∂®
  51   1      //      {
  52   1                      if((*pKeyValue==4)&&(key_stateValue == return_keyPressed) )//µ˜ ‘∞¥º¸
  53   1                      {
  54   2                              SYS_STEP++;
C51 COMPILER V9.00   MAIN                                                                  06/23/2015 07:53:34 PAGE 2   

  55   2                              if(SYS_STEP>5) 
  56   2                              {
  57   3                                      SYS_STEP = 1;
  58   3                              }
  59   2                              if(SYS_STEP == 1){SYS_Time.GHour = 0;SYS_Time.GMintes = 0;SYS_Time.GSeconds = 0;}
  60   2                              if(SYS_STEP == 2){SYS_Time.GHour = 6;SYS_Time.GMintes = 0;SYS_Time.GSeconds = 0;}//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂Œ
             -µƒ ±º‰6~9–° ± 
  61   2                              if(SYS_STEP == 3){SYS_Time.GHour = 9;SYS_Time.GMintes = 0;SYS_Time.GSeconds = 0;}//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂Œ
             -µƒ ±º‰6~9–° ± 
  62   2                              if(SYS_STEP == 4){SYS_Time.GHour = 12;SYS_Time.GMintes = 0;SYS_Time.GSeconds = 0;}//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂
             -Œµƒ ±º‰6~9–° ±        
  63   2                      }
  64   1                      if((*pKeyValue==3)&&(key_stateValue == return_keyPressed) )//≤Œ ˝—°‘Ò∞¥º¸
  65   1                      {
  66   2                              Change_Num++;
  67   2                              if(Change_Num>3) 
  68   2                              {
  69   3                                      Save_Flag = 1;  //ø™ º±£¥Ê ˝æ›
  70   3                                      Change_Num = 0;
  71   3                              }
  72   2                                      
  73   2                      }
  74   1                      if((key_stateValue == return_keyPressed)||(key_stateValue & return_keyAuto) )//≥§∞¥º¸º”¡¨∑¢
  75   1                      {
  76   2                              if((*pKeyValue==UP)&&(Change_Num!=0))
  77   2                              {
  78   3                                      switch(Change_Num)
  79   3                                      {
  80   4                                              case 1:CurrentBase[SYS_STEP]++;
  81   4                      
  82   4                                                         break;
  83   4                                              case 2:VoltageBase[SYS_STEP]++;
  84   4                                                      
  85   4                                                         break;
  86   4                                              case 3:CurrentInput[SYS_STEP]++;
  87   4                                                         
  88   4                                                              break;
  89   4      
  90   4                                      }
  91   3                              }
  92   2                              if((*pKeyValue==DOWN)&&(Change_Num!=0))
  93   2                              {
  94   3                                      switch(Change_Num)
  95   3                                      {
  96   4                                              case 1:CurrentBase[SYS_STEP]--;break;
  97   4                                              case 2:VoltageBase[SYS_STEP]--;break;
  98   4                                              case 3:CurrentInput[SYS_STEP]--;break;
  99   4                                                              
 100   4                                                      
 101   4                                      }
 102   3                              }
 103   2      
 104   2                      }
 105   1      //      }
 106   1              
 107   1              
 108   1              
 109   1      }
 110          void UserData_Claculite()//”√ªß ˝æ›∑÷Œˆ£¨≈–∂œ∏√÷¥––µ⁄º∏≤Ω
 111          {
 112   1              
 113   1              if( (AD<= CurrentInput[SYS_STEP])&&(SYS_STEP < 4))//»Áπ˚µÁ¡˜ ‰»Î–≈∫≈µÕ”⁄2.0V≤¢«“≥¨π˝10S,«∞3≤Ω÷¥––£¨
C51 COMPILER V9.00   MAIN                                                                  06/23/2015 07:53:34 PAGE 3   

 114   1              {
 115   2      //              if(AD <= 0x2c)//»Áπ˚µÁ¡˜ ‰»Î–≈∫≈µÕ”⁄0.2V‘›Õ£º∆ ±
 116   2      //              {
 117   2      //                      Delay_nms(100);
 118   2      //                      while(Get_ad_result(5)<=0x2c)
 119   2      //                      {
 120   2      //                              TR0 = 0;//‘›Õ£º∆ ±∆˜
 121   2      //                              LedShanShuo();
 122   2      //                      }
 123   2      //                      TR0 = 1;//¥Úø™º∆ ±∆˜
 124   2      //              }
 125   2      //              else
 126   2      //              {
 127   2                              Wait_Flag = 1;
 128   2                              if(time_wait>=1000)//≥¨π˝10S
 129   2                              {               
 130   3                                      SYS_STEP++;//◊™µΩœ¬“ª≤Ω 
 131   3                                      Wait_Flag = 0;
 132   3                                      time_wait = 0;
 133   3                                      Led0 = 0;
 134   3                                      if(SYS_STEP == 2)SYS_Time.GHour = 6;//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂Œµƒ ±º‰6~9–° ± 
 135   3                                      if(SYS_STEP == 3)SYS_Time.GHour = 9;//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂Œµƒ ±º‰6~9–° ± 
 136   3                                      if(SYS_STEP == 4)SYS_Time.GHour = 12;//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂Œµƒ ±º‰6~9–° ± 
 137   3                              }
 138   2                              if(time_wait>=50)//ºÏ≤‚10¥Œ∑¿÷π¥ÌŒÛºÏ≤‚
 139   2                              {
 140   3                                      Led0 = 1;
 141   3                                      
 142   3                              }
 143   2      //              }
 144   2                      
 145   2                                                              
 146   2              }
 147   1              else
 148   1              {
 149   2                      Wait_Flag = 0;//πÿ±’µ»¥˝º∆ ±
 150   2                      time_wait = 0;
 151   2                      Led0 = 0;
 152   2              }
 153   1      
 154   1              if(AD0 <= 615)//»Áπ˚µÁ¡˜ ‰»Î–≈∫≈µÕ”⁄3V‘›Õ£º∆ ± 0x0267
 155   1              {
 156   2                      Delay_nms(100);
 157   2                      while(Get_ad_result(2)<=615)
 158   2                      {
 159   3                              TR0 = 0;//‘›Õ£º∆ ±∆˜
 160   3                              LedShanShuo();
 161   3                      }
 162   2                      TR0 = 1;//¥Úø™º∆ ±∆˜
 163   2              }
 164   1              
 165   1      }
 166          void main()
 167          {
 168   1          Key_Init();
 169   1              InitUart();
 170   1              LedPortInit();
 171   1              Timer0Init();
 172   1              AD_init();
 173   1              PWMn_init();
 174   1          while(UserData_Init0()) LedShanShuo();
 175   1              EA = 1;
C51 COMPILER V9.00   MAIN                                                                  06/23/2015 07:53:34 PAGE 4   

 176   1              Delay_nms(1000);
 177   1              while(1)
 178   1              {
 179   2      //              EA = 1;
 180   2      //              TR0 = 1;
 181   2                      AD0 = Get_ad_result(2);         
 182   2                      AD = Get_ad_result(3);
 183   2                      UserData_Claculite();
 184   2                      if(Change_Num) Current_Time = 0;//¥Àæ‰ «Œ™¡À‘⁄–ﬁ’˝ « ˝æ› ‰≥ˆø⁄≤ª∑¥◊™”√µƒ
 185   2                      switch(SYS_STEP)// ’˚∏ˆœµÕ≥÷¥––¡˜≥Ã
 186   2                      {
 187   3                              case 1://µ⁄“ªΩ◊∂Œ 0 ~ 6–° ± 
 188   3                              {
 189   4                                      
 190   4                                      if(Current_Time<30)//30√Î2.5V
 191   4                                      {
 192   5                                              PWM0_set (0,CurrentBase[SYS_STEP]);
 193   5                                              
 194   5                                      }
 195   4                                      else if(Current_Time<35)
 196   4                                              {
 197   5                                                      PWM0_set (0,0x33);//5√Î1V
 198   5                                              }
 199   4                                              else
 200   4                                              {
 201   5                                                      Current_Time = 0;
 202   5                                              }
 203   4                                      PWM0_set (1,VoltageBase[SYS_STEP]);
 204   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 205   4                                      {
 206   5                                              Led1 = 1;
 207   5                                              Led2 = 0;
 208   5                                              Led3 = 0;
 209   5                                      }
 210   4                                      
 211   4                                      if(SYS_Time.GHour==6)SYS_STEP++;//  ±º‰µΩ◊™µΩœ¬“ª≤Ω                             
 212   4                                      break;
 213   4                              }
 214   3                              case 2://µ⁄“ªΩ◊∂Œ 6 ~ 9–° ± 
 215   3                              {
 216   4                                      if(Current_Time<30)//30√Î2.5V
 217   4                                      {
 218   5                                              PWM0_set (0,CurrentBase[SYS_STEP]);
 219   5                                              
 220   5                                      }
 221   4                                      else if(Current_Time<35)
 222   4                                              {
 223   5                                                      PWM0_set (0,0x33);//5√Î1V
 224   5                                              }
 225   4                                              else
 226   4                                              {
 227   5                                                      Current_Time = 0;
 228   5                                              }
 229   4                                      PWM0_set (1,VoltageBase[SYS_STEP]);
 230   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 231   4                                      {
 232   5                                              Led1 = 0;
 233   5                                              Led2 = 1;
 234   5                                              Led3 = 0;
 235   5                                      }
 236   4                                      if(SYS_Time.GHour==9)SYS_STEP++;
 237   4                                      break;
C51 COMPILER V9.00   MAIN                                                                  06/23/2015 07:53:34 PAGE 5   

 238   4                              }                       
 239   3                              case 3://µ⁄“ªΩ◊∂Œ 9 ~ 12–° ± 
 240   3                              {
 241   4                                      if(Current_Time<30)//30√Î2.5V
 242   4                                      {
 243   5                                              PWM0_set (0,CurrentBase[SYS_STEP]);
 244   5                                              
 245   5                                      }
 246   4                                      else if(Current_Time<35)
 247   4                                              {
 248   5                                                      PWM0_set (0,0x19);//5√Î0.5V
 249   5                                              }
 250   4                                              else
 251   4                                              {
 252   5                                                      Current_Time = 0;
 253   5                                              }
 254   4                                      PWM0_set (1,VoltageBase[SYS_STEP]);
 255   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 256   4                                      {
 257   5                                              Led1 = 0;
 258   5                                              Led2 = 0;
 259   5                                              Led3 = 1;
 260   5                                      }
 261   4                                      if(SYS_Time.GHour==12)SYS_STEP++;//  ±º‰µΩ◊™µΩœ¬“ª≤Ω    
 262   4                                      break;
 263   4                              }
 264   3                              case 4://µ⁄“ªΩ◊∂Œ 12 ~ 14–° ± 
 265   3                              {
 266   4                                      PWM0_set (0,CurrentBase[SYS_STEP]);
 267   4                                      PWM0_set (1,VoltageBase[SYS_STEP]);
 268   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 269   4                                      {
 270   5                                              Led1 = 0;
 271   5                                              Led2 = 0;
 272   5                                              Led3 = 0;
 273   5                                      }
 274   4                                      if(SYS_Time.GHour==14)SYS_STEP++;//  ±º‰µΩ◊™µΩœ¬“ª≤Ω    
 275   4                                      break;
 276   4                              }
 277   3                              case 5://≥‰¬˙
 278   3                              {
 279   4                                      PWM0_set (0,CurrentBase[0]);
 280   4                                      PWM0_set (1,VoltageBase[0]);
 281   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 282   4                                      {
 283   5                                              Led1 = 0;
 284   5                                              Led2 = 0;
 285   5                                              Led3 = 0;
 286   5                                      }
 287   4      //                              SYS_STEP = 1;
 288   4                                      break;
 289   4                              }
 290   3                      }
 291   2                      switch(Change_Num)
 292   2                      {
 293   3                              case 1:LedShanShuo1();break;
 294   3                              case 2:LedShanShuo2();break;
 295   3                              case 3:LedShanShuo3();break;
 296   3                              case 0:  break;
 297   3                      }
 298   2                      if(Save_Flag == 1)
 299   2                      {
C51 COMPILER V9.00   MAIN                                                                  06/23/2015 07:53:34 PAGE 6   

 300   3                              Save_Flag = 0;
 301   3                              UserData_Init0();
 302   3                              LedShanShuo();
 303   3                      }
 304   2                      
 305   2                      
 306   2              }
 307   1      
 308   1      }
 309          //-----------------------------------------------
 310          
 311          /* Timer0 interrupt routine */
 312          void tm0_isr() interrupt 1 using 1
 313          {
 314   1              TL0 = T0MS;                     //≥ı ºªØº∆ ±÷µ
 315   1          TH0 = T0MS >> 8;
 316   1              Time_Base++;
 317   1              if(Time_Base>=100)
 318   1              {
 319   2                      Time_Base = 0;
 320   2                      Current_Time++;//”√”⁄ ‰≥ˆø⁄1 30√Î∫Õ5√Î÷ÿ∏¥”√
 321   2                      SYS_Time.GSeconds++;
 322   2                      if(SYS_Time.GSeconds>59) 
 323   2                      {
 324   3                              SYS_Time.GSeconds=0;
 325   3                              SYS_Time.GMintes++;
 326   3                      }
 327   2                      if(SYS_Time.GMintes>59) 
 328   2                      {
 329   3                              SYS_Time.GMintes=0;
 330   3                              SYS_Time.GHour++;
 331   3                      }
 332   2                      if(SYS_Time.GHour>23) 
 333   2                      {
 334   3                              SYS_Time.GHour=0;
 335   3                      }
 336   2      
 337   2              }
 338   1              if(Wait_Flag)time_wait++;//÷¥––÷‹∆⁄Œ™10ms       
 339   1              user_app();                      
 340   1      }
 341          /*----------------------------
 342          UART interrupt service routine
 343          ----------------------------*/
 344          void Uart_Isr() interrupt 4 using 1
 345          {
 346   1          if (RI)
 347   1          {
 348   2              RI = 0;             //Clear receive interrupt flag
 349   2              DA = SBUF; 
 350   2      //              SendData(DA);
 351   2      //              PWM0_set (0,DA);
 352   2      //              PWM0_set (1,DA); 
 353   2                      if(DA == 0xaa)
 354   2                      {
 355   3                              IapEraseSector(0x0000);//≤¡≥ˆµ⁄“ª∏ˆ…»«¯
 356   3                              IapEraseSector(0x0200);//≤¡≥ˆµ⁄∂˛∏ˆ…»«¯
 357   3                      }
 358   2                      if(DA == 1)
 359   2                      {
 360   3                              SendData(CurrentBase[SYS_STEP]);
 361   3                              SendData(VoltageBase[SYS_STEP]);
C51 COMPILER V9.00   MAIN                                                                  06/23/2015 07:53:34 PAGE 7   

 362   3                              SendData(CurrentInput[SYS_STEP]>>8);
 363   3                              SendData(CurrentInput[SYS_STEP]&0xff);
 364   3                      }
 365   2                      if(DA == 2)
 366   2                      {
 367   3                              SendData(2);
 368   3                              SendData(AD0>>8);
 369   3                              SendData(AD0);
 370   3                              SendData(3);
 371   3                              SendData(AD>>8);
 372   3                              SendData(AD);
 373   3                      
 374   3                      }
 375   2                      if(DA == 3)
 376   2                      {
 377   3                              SendData(SYS_Time.GHour);
 378   3                              SendData(SYS_Time.GMintes);
 379   3                              SendData(SYS_Time.GSeconds);
 380   3                      }
 381   2                      if(DA == 0x12)
 382   2                      {
 383   3                              SYS_Time.GHour = 5;
 384   3                              SYS_Time.GMintes = 59;
 385   3                              SYS_Time.GSeconds = 40;
 386   3                              SendData(SYS_Time.GHour);
 387   3                              SendData(SYS_Time.GMintes);
 388   3                              SendData(SYS_Time.GSeconds);
 389   3                      }
 390   2                      if(DA == 0x23)
 391   2                      {
 392   3                              SYS_Time.GHour = 8;
 393   3                              SYS_Time.GMintes = 59;
 394   3                              SYS_Time.GSeconds = 40;
 395   3                              SendData(SYS_Time.GHour);
 396   3                              SendData(SYS_Time.GMintes);
 397   3                              SendData(SYS_Time.GSeconds);
 398   3                      }
 399   2                      if(DA == 0x34)
 400   2                      {
 401   3                              SYS_Time.GHour = 11;
 402   3                              SYS_Time.GMintes = 59;
 403   3                              SYS_Time.GSeconds = 40;
 404   3                              SendData(SYS_Time.GHour);
 405   3                              SendData(SYS_Time.GMintes);
 406   3                              SendData(SYS_Time.GSeconds);
 407   3                      }
 408   2                      if(DA == 0x45)
 409   2                      {
 410   3                              SYS_Time.GHour = 13;
 411   3                              SYS_Time.GMintes = 59;
 412   3                              SYS_Time.GSeconds = 40;
 413   3                              SendData(SYS_Time.GHour);
 414   3                              SendData(SYS_Time.GMintes);
 415   3                              SendData(SYS_Time.GSeconds);
 416   3                      }
 417   2          }
 418   1      }
 419           WORD Get_SYSTime()
 420          {
 421   1              return Time_Base;
 422   1      }

C51 COMPILER V9.00   MAIN                                                                  06/23/2015 07:53:34 PAGE 8   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1180    ----
=======
  27          BYTE DA = 10;      
  28          BYTE CurrentBase[6] = {0x00,0x80,0x67,0x33,0x19,0};//0\2.5\2.0\1.0\0.5 µÁ¡˜ª˘◊º
  29          BYTE VoltageBase[6] = {0x00,0x9a,0xce,0xce,0xb4,0};//0\3\4\4\3.5       µÁ—πª˘◊º
  30          WORD CurrentInput[6] = {0x00,0x019f,0x00d1,0x006a,0,0};//0\2\1\0.5\      µÁ¡˜ ‰»Î–≈∫≈
  31          BYTE Current_Base = 0;
  32          BYTE Voltage_Base = 0;
  33          BYTE Change_Num = 0; //—°‘Ò≤Œ ˝œÓ
  34          BYTE Wait_Flag = 0;
  35          BYTE Save_Flag = 0;//¥Ê¥¢ ˝æ›µƒ±Í÷æ
  36          BYTE Warrning_Flag = 0;//¥Ê¥¢ ˝æ›µƒ±Í÷æ
  37          u16 time_wait =0;
  38          u8  Current_Time = 0;
  39          
  40          void user_app()//”√ªß≥Ã–Ú
  41          {
  42   1          u8 key_stateValue;  
  43   1          u8* pKeyValue;  
  44   1          *pKeyValue=0;  
  45   1          key_stateValue=read_key(pKeyValue); 
  46   1              if(Key_Lock==1)//À¯∂®º¸£¨Œ™1Ω‚≥˝À¯∂®£¨Œ™0À¯∂®
  47   1              {
  48   2                      if((*pKeyValue==4)&&(key_stateValue == return_keyPressed) )//µ˜ ‘∞¥º¸
  49   2                      {
  50   3                              SYS_STEP++;
  51   3                              if(SYS_STEP>5) 
  52   3                              {
  53   4                                      SYS_STEP = 1;
  54   4                              }
C51 COMPILER V9.00   MAIN                                                                  06/16/2015 21:32:12 PAGE 2   

  55   3                                      
  56   3                      }
  57   2                      if((*pKeyValue==3)&&(key_stateValue == return_keyPressed) )//≤Œ ˝—°‘Ò∞¥º¸
  58   2                      {
  59   3                              Change_Num++;
  60   3                              if(Change_Num>3) 
  61   3                              {
  62   4                                      Save_Flag = 1;  //ø™ º±£¥Ê ˝æ›
  63   4                                      Change_Num = 0;
  64   4                              }
  65   3                                      
  66   3                      }
  67   2                      if((key_stateValue == return_keyPressed)||(key_stateValue & return_keyAuto) )//≥§∞¥º¸º”¡¨∑¢
  68   2                      {
  69   3                              if((*pKeyValue==UP)&&(Change_Num!=0))
  70   3                              {
  71   4                                      switch(Change_Num)
  72   4                                      {
  73   5                                              case 1:CurrentBase[SYS_STEP]++;
  74   5                      
  75   5                                                         break;
  76   5                                              case 2:VoltageBase[SYS_STEP]++;
  77   5                                                      
  78   5                                                         break;
  79   5                                              case 3:CurrentInput[SYS_STEP]++;
  80   5                                                         
  81   5                                                              break;
  82   5      
  83   5                                      }
  84   4                              }
  85   3                              if((*pKeyValue==DOWN)&&(Change_Num!=0))
  86   3                              {
  87   4                                      switch(Change_Num)
  88   4                                      {
  89   5                                              case 1:CurrentBase[SYS_STEP]--;break;
  90   5                                              case 2:VoltageBase[SYS_STEP]--;break;
  91   5                                              case 3:CurrentInput[SYS_STEP]--;break;
  92   5                                                              
  93   5                                                      
  94   5                                      }
  95   4                              }
  96   3      
  97   3                      }
  98   2              }
  99   1              
 100   1              
 101   1              
 102   1      }
 103          void UserData_Claculite()//”√ªß ˝æ›∑÷Œˆ£¨≈–∂œ∏√÷¥––µ⁄º∏≤Ω
 104          {
 105   1              
 106   1              if( (AD<= CurrentInput[SYS_STEP])&&(SYS_STEP < 4))//»Áπ˚µÁ¡˜ ‰»Î–≈∫≈µÕ”⁄2.0V≤¢«“≥¨π˝10S,«∞3≤Ω÷¥––£¨
 107   1              {
 108   2                      if(AD <= 0x2c)//»Áπ˚µÁ¡˜ ‰»Î–≈∫≈µÕ”⁄0.2V‘›Õ£º∆ ±
 109   2                      {
 110   3                              Delay_nms(100);
 111   3                              while(Get_ad_result(5)<=0x2c)
 112   3                              {
 113   4                                      TR0 = 0;//‘›Õ£º∆ ±∆˜
 114   4                                      LedShanShuo();
 115   4                              }
 116   3                              TR0 = 1;//¥Úø™º∆ ±∆˜
C51 COMPILER V9.00   MAIN                                                                  06/16/2015 21:32:12 PAGE 3   

 117   3                      }
 118   2                      else
 119   2                      {
 120   3                              Wait_Flag = 1;
 121   3                              if(time_wait>=1000)//≥¨π˝10S
 122   3                              {               
 123   4                                      SYS_STEP++;//◊™µΩœ¬“ª≤Ω 
 124   4                                      Wait_Flag = 0;
 125   4                                      time_wait = 0;
 126   4                                      Led0 = 0;
 127   4                                      if(SYS_STEP == 2)SYS_Time.GHour = 6;//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂Œµƒ ±º‰6~9–° ± 
 128   4                                      if(SYS_STEP == 3)SYS_Time.GHour = 9;//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂Œµƒ ±º‰6~9–° ± 
 129   4                                      if(SYS_STEP == 4)SYS_Time.GHour = 12;//Ω´ ±º‰…Ë÷√µΩµ⁄∂˛Ω◊∂Œµƒ ±º‰6~9–° ± 
 130   4                              }
 131   3                              if(time_wait>=50)//ºÏ≤‚10¥Œ∑¿÷π¥ÌŒÛºÏ≤‚
 132   3                              {
 133   4                                      Led0 = 1;
 134   4                                      
 135   4                              }
 136   3                      }
 137   2                      
 138   2                                                              
 139   2              }
 140   1              else
 141   1              {
 142   2                      Wait_Flag = 0;//πÿ±’µ»¥˝º∆ ±
 143   2                      time_wait = 0;
 144   2                      Led0 = 0;
 145   2              }
 146   1      
 147   1              
 148   1              
 149   1      }
 150          void main()
 151          {
 152   1          Key_Init();
 153   1              InitUart();
 154   1              LedPortInit();
 155   1              Timer0Init();
 156   1              AD_init();
 157   1              PWMn_init();
 158   1          while(UserData_Init()) LedShanShuo();
 159   1              EA = 1;
 160   1              Delay_nms(1000);
 161   1              while(1)
 162   1              {
 163   2      //              EA = 1;
 164   2      //              TR0 = 1;
 165   2                      AD = Get_ad_result(5);
 166   2                      UserData_Claculite();
 167   2                      if(Change_Num) Current_Time = 0;//¥Àæ‰ «Œ™¡À‘⁄–ﬁ’˝ « ˝æ› ‰≥ˆø⁄≤ª∑¥◊™”√µƒ
 168   2                      switch(SYS_STEP)// ’˚∏ˆœµÕ≥÷¥––¡˜≥Ã
 169   2                      {
 170   3                              case 1://µ⁄“ªΩ◊∂Œ 0 ~ 6–° ± 
 171   3                              {
 172   4                                      
 173   4                                      if(Current_Time<30)//30√Î2.5V
 174   4                                      {
 175   5                                              PWM0_set (0,CurrentBase[SYS_STEP]);
 176   5                                              
 177   5                                      }
 178   4                                      else if(Current_Time<35)
C51 COMPILER V9.00   MAIN                                                                  06/16/2015 21:32:12 PAGE 4   

 179   4                                              {
 180   5                                                      PWM0_set (0,0x33);//5√Î1V
 181   5                                              }
 182   4                                              else
 183   4                                              {
 184   5                                                      Current_Time = 0;
 185   5                                              }
 186   4                                      PWM0_set (1,VoltageBase[SYS_STEP]);
 187   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 188   4                                      {
 189   5                                              Led1 = 1;
 190   5                                              Led2 = 0;
 191   5                                              Led3 = 0;
 192   5                                      }
 193   4                                      
 194   4                                      if(SYS_Time.GHour==6)SYS_STEP++;//  ±º‰µΩ◊™µΩœ¬“ª≤Ω                             
 195   4                                      break;
 196   4                              }
 197   3                              case 2://µ⁄“ªΩ◊∂Œ 6 ~ 9–° ± 
 198   3                              {
 199   4                                      if(Current_Time<30)//30√Î2.5V
 200   4                                      {
 201   5                                              PWM0_set (0,CurrentBase[SYS_STEP]);
 202   5                                              
 203   5                                      }
 204   4                                      else if(Current_Time<35)
 205   4                                              {
 206   5                                                      PWM0_set (0,0x33);//5√Î1V
 207   5                                              }
 208   4                                              else
 209   4                                              {
 210   5                                                      Current_Time = 0;
 211   5                                              }
 212   4                                      PWM0_set (1,VoltageBase[SYS_STEP]);
 213   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 214   4                                      {
 215   5                                              Led1 = 0;
 216   5                                              Led2 = 1;
 217   5                                              Led3 = 0;
 218   5                                      }
 219   4                                      if(SYS_Time.GHour==9)SYS_STEP++;
 220   4                                      break;
 221   4                              }                       
 222   3                              case 3://µ⁄“ªΩ◊∂Œ 9 ~ 12–° ± 
 223   3                              {
 224   4                                      if(Current_Time<30)//30√Î2.5V
 225   4                                      {
 226   5                                              PWM0_set (0,CurrentBase[SYS_STEP]);
 227   5                                              
 228   5                                      }
 229   4                                      else if(Current_Time<35)
 230   4                                              {
 231   5                                                      PWM0_set (0,0x19);//5√Î0.5V
 232   5                                              }
 233   4                                              else
 234   4                                              {
 235   5                                                      Current_Time = 0;
 236   5                                              }
 237   4                                      PWM0_set (1,VoltageBase[SYS_STEP]);
 238   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 239   4                                      {
 240   5                                              Led1 = 0;
C51 COMPILER V9.00   MAIN                                                                  06/16/2015 21:32:12 PAGE 5   

 241   5                                              Led2 = 0;
 242   5                                              Led3 = 1;
 243   5                                      }
 244   4                                      if(SYS_Time.GHour==12)SYS_STEP++;//  ±º‰µΩ◊™µΩœ¬“ª≤Ω    
 245   4                                      break;
 246   4                              }
 247   3                              case 4://µ⁄“ªΩ◊∂Œ 12 ~ 14–° ± 
 248   3                              {
 249   4                                      PWM0_set (0,CurrentBase[SYS_STEP]);
 250   4                                      PWM0_set (1,VoltageBase[SYS_STEP]);
 251   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 252   4                                      {
 253   5                                              Led1 = 0;
 254   5                                              Led2 = 0;
 255   5                                              Led3 = 0;
 256   5                                      }
 257   4                                      if(SYS_Time.GHour==14)SYS_STEP++;//  ±º‰µΩ◊™µΩœ¬“ª≤Ω    
 258   4                                      break;
 259   4                              }
 260   3                              case 5://≥‰¬˙
 261   3                              {
 262   4                                      PWM0_set (0,CurrentBase[0]);
 263   4                                      PWM0_set (1,VoltageBase[0]);
 264   4                                      if(Change_Num==0)//±‹√‚∫Õ”√ªßµ˜Ω⁄ «µƒ÷∏ æµ∆ª•œ‡∏…»≈
 265   4                                      {
 266   5                                              Led1 = 0;
 267   5                                              Led2 = 0;
 268   5                                              Led3 = 0;
 269   5                                      }
 270   4      //                              SYS_STEP = 1;
 271   4                                      break;
 272   4                              }
 273   3                      }
 274   2                      switch(Change_Num)
 275   2                      {
 276   3                              case 1:LedShanShuo1();break;
 277   3                              case 2:LedShanShuo2();break;
 278   3                              case 3:LedShanShuo3();break;
 279   3                              case 0:  break;
 280   3                      }
 281   2                      if(Save_Flag == 1)
 282   2                      {
 283   3                              Save_Flag = 0;
 284   3                              UserData_Init0();
 285   3                              LedShanShuo();
 286   3                      }
 287   2                                      
 288   2                      Delay_nms(10);
 289   2                      
 290   2              }
 291   1      
 292   1      }
 293          //-----------------------------------------------
 294          
 295          /* Timer0 interrupt routine */
 296          void tm0_isr() interrupt 1 using 1
 297          {
 298   1              TL0 = T0MS;                     //≥ı ºªØº∆ ±÷µ
 299   1          TH0 = T0MS >> 8;
 300   1              Time_Base++;
 301   1              if(Time_Base>=100)
 302   1              {
C51 COMPILER V9.00   MAIN                                                                  06/16/2015 21:32:12 PAGE 6   

 303   2                      Time_Base = 0;
 304   2                      Current_Time++;//”√”⁄ ‰≥ˆø⁄1 30√Î∫Õ5√Î÷ÿ∏¥”√
 305   2                      SYS_Time.GSeconds++;
 306   2                      if(SYS_Time.GSeconds>59) 
 307   2                      {
 308   3                              SYS_Time.GSeconds=0;
 309   3                              SYS_Time.GMintes++;
 310   3                      }
 311   2                      if(SYS_Time.GMintes>59) 
 312   2                      {
 313   3                              SYS_Time.GMintes=0;
 314   3                              SYS_Time.GHour++;
 315   3                      }
 316   2                      if(SYS_Time.GHour>23) 
 317   2                      {
 318   3                              SYS_Time.GHour=0;
 319   3                      }
 320   2      
 321   2              }
 322   1              if(Wait_Flag)time_wait++;//÷¥––÷‹∆⁄Œ™10ms       
 323   1              user_app();                      
 324   1      }
 325          /*----------------------------
 326          UART interrupt service routine
 327          ----------------------------*/
 328          void Uart_Isr() interrupt 4 using 1
 329          {
 330   1          if (RI)
 331   1          {
 332   2              RI = 0;             //Clear receive interrupt flag
 333   2              DA = SBUF; 
 334   2      //              SendData(DA);
 335   2      //              PWM0_set (0,DA);
 336   2      //              PWM0_set (1,DA); 
 337   2                      if(DA == 0xaa)
 338   2                      {
 339   3                              IapEraseSector(0x0000);//≤¡≥ˆµ⁄“ª∏ˆ…»«¯
 340   3                              IapEraseSector(0x0200);//≤¡≥ˆµ⁄∂˛∏ˆ…»«¯
 341   3                      }
 342   2                      if(DA == 1)
 343   2                      {
 344   3                              SendData(CurrentBase[SYS_STEP]);
 345   3                              SendData(VoltageBase[SYS_STEP]);
 346   3                              SendData(CurrentInput[SYS_STEP]>>8);
 347   3                              SendData(CurrentInput[SYS_STEP]&0xff);
 348   3                      }
 349   2                      if(DA == 2)
 350   2                      {
 351   3                              SendData(AD>>8);
 352   3                              SendData(AD);
 353   3                      }
 354   2                      if(DA == 3)
 355   2                      {
 356   3                              SendData(SYS_Time.GHour);
 357   3                              SendData(SYS_Time.GMintes);
 358   3                              SendData(SYS_Time.GSeconds);
 359   3                      }
 360   2          }
 361   1      }
 362           WORD Get_SYSTime()
 363          {
 364   1              return Time_Base;
C51 COMPILER V9.00   MAIN                                                                  06/16/2015 21:32:12 PAGE 7   

 365   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    985    ----
>>>>>>> parent of 838f16f... ËØ¥ÊòéÔºö‰øÆÊîπËá≥ÊúÄÊñ∞ÔºåÊåâÈîÆÊúâÂ§ßÁöÑÊîπÂä®ÔºåÂ¢ûÂä†‰ø°Âè∑Ê£ÄÊµãÁ´ØÂè£„ÄÇ
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     44       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
